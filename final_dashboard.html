<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>재무제표 분석 대시보드</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }

		body {
			font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px;
		}

		.container {
			max-width: 1600px;
			margin: 0 auto;
			background: white;
			border-radius: 20px;
			padding: 40px;
			box-shadow: 0 20px 60px rgba(0,0,0,0.3);
		}

		header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 30px;
			border-bottom: 3px solid #667eea;
			padding-bottom: 20px;
			gap: 30px;
		}

		.header-center {
			flex: 1;
			text-align: center;
		}

		.search-wrapper {
			position: relative;
			min-width: 280px;
		}

		#companySearch {
			width: 100%;
			padding: 12px 40px 12px 15px;
			font-size: 14px;
			border: 2px solid #667eea;
			border-radius: 50px;
			outline: none;
			transition: all 0.3s;
		}

		#companySearch:focus {
			box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
			border-color: #764ba2;
		}

		.search-icon {
			position: absolute;
			right: 15px;
			top: 50%;
			transform: translateY(-50%);
			color: #667eea;
			font-size: 18px;
			pointer-events: none;
		}

		.search-results {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: white;
			border: 2px solid #667eea;
			border-radius: 15px;
			margin-top: 8px;
			max-height: 400px;
			overflow-y: auto;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			z-index: 1000;
			display: none;
		}

		.search-results.show {
			display: block;
		}

		.search-result-item {
			padding: 12px 20px;
			cursor: pointer;
			border-bottom: 1px solid #ecf0f1;
			transition: all 0.2s;
		}

		.search-result-item:last-child {
			border-bottom: none;
		}

		.search-result-item:hover {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}

		.company-name {
			font-weight: bold;
			font-size: 15px;
		}

		.company-info {
			font-size: 12px;
			color: #7f8c8d;
			margin-top: 3px;
		}

		.search-result-item:hover .company-info {
			color: rgba(255,255,255,0.8);
		}

		.no-results {
			padding: 20px;
			text-align: center;
			color: #7f8c8d;
		}

		h1 {
			color: #2c3e50;
			font-size: 32px;
			margin-bottom: 10px;
		}

		.controls {
			display: flex;
			justify-content: center;
			gap: 20px;
			margin-bottom: 30px;
			flex-wrap: wrap;
		}

		select, .view-btn {
			padding: 12px 25px;
			font-size: 14px;
			font-weight: bold;
			border: 2px solid #667eea;
			border-radius: 50px;
			cursor: pointer;
			background: white;
			color: #2c3e50;
			transition: all 0.3s;
		}

		.view-btn.active {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}

		.view-content { display: none; }
		.view-content.active { display: block; animation: fadeIn 0.5s; }

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(20px); }
			to { opacity: 1; transform: translateY(0); }
		}

		.chart-container {
			height: 500px;
			margin-bottom: 30px;
			background: #f8f9fa;
			padding: 20px;
			border-radius: 15px;
		}

		.loading {
			text-align: center;
			padding: 50px;
			color: #7f8c8d;
		}

		.trend-wrapper {
			display: flex;
			gap: 20px;
			align-items: start;
			margin-bottom: 20px;
		}

		.selector-wrapper {
			min-width: 200px;
		}

		.chart-wrapper {
			flex: 1;
		}

		/* T-Account 스타일 */
		.t-account-container {
			display: grid;
			grid-template-columns: 1fr 2px 1fr;
			gap: 0;
			min-height: 500px;
			background: white;
			border-radius: 15px;
			padding: 30px;
			box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}

		.t-column {
			display: flex;
			flex-direction: column;
			gap: 2px;
		}

		.t-divider {
			background: #2c3e50;
			width: 3px;
		}

		.t-title {
			text-align: center;
			font-size: 20px;
			font-weight: bold;
			color: #2c3e50;
			margin-bottom: 20px;
			padding: 10px;
			background: #ecf0f1;
			border-radius: 10px;
		}

		.t-item {
			position: relative;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border-radius: 8px;
			padding: 8px 12px;
			color: white;
			cursor: pointer;
			transition: all 0.3s;
			display: flex;
			justify-content: space-between;
			align-items: center;
			overflow: hidden;
		}

		.t-item:hover {
			transform: scale(1.02);
			box-shadow: 0 8px 20px rgba(0,0,0,0.2);
		}

		.t-item.expense { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
		.t-item.profit { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
		.t-item.revenue { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }

		.t-label {
			font-size: 13px;
			font-weight: bold;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			flex: 1;
			margin-right: 10px;
		}

		.t-amount {
			font-size: 14px;
			font-weight: bold;
			white-space: nowrap;
			text-align: right;
		}

		.t-group-wrapper {
			display: grid;
			grid-template-columns: 120px 1fr;
			gap: 10px;
			margin-bottom: 8px;
			align-items: center;
		}

		.t-group-label {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			padding: 10px 15px;
			border-radius: 8px;
			font-size: 13px;
			font-weight: bold;
			color: white;
			text-align: center;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			height: 100%;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			gap: 3px;
			transition: all 0.3s;
		}

		.t-group-label:hover {
			transform: scale(1.02);
			box-shadow: 0 8px 20px rgba(0,0,0,0.2);
		}

		.t-group-total {
			font-size: 14px;
			color: white;
			font-weight: bold;
		}

		.t-group {
			border: 2px dashed rgba(108, 122, 137, 0.5);
			border-radius: 12px;
			padding: 8px;
			position: relative;
		}

		.t-group-content {
			display: flex;
			flex-direction: column;
			gap: 2px;
		}

		.t-caption {
			display: none;
			position: absolute;
			bottom: 100%;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0,0,0,0.9);
			color: white;
			padding: 12px 15px;
			border-radius: 8px;
			font-size: 12px;
			white-space: nowrap;
			z-index: 10;
			margin-bottom: 10px;
		}

		.t-item:hover .t-caption {
			display: block;
		}

		/* 모바일 반응형 디자인 */
		@media (max-width: 768px) {
			body {
				padding: 10px;
			}

			.container {
				padding: 20px;
				border-radius: 15px;
			}

			header {
				flex-direction: column;
				gap: 15px;
				padding-bottom: 15px;
			}

			.header-center {
				order: -1;
			}

			.search-wrapper {
				width: 100%;
				min-width: unset;
			}

			header > div:last-child {
				width: 100%;
				min-width: unset;
				justify-content: center;
			}

			h1 {
				font-size: 24px;
			}

			.header-center p {
				font-size: 11px;
			}

			.controls {
				flex-direction: column;
				gap: 10px;
			}

			.view-btn {
				width: 100%;
				font-size: 13px;
				padding: 10px 15px;
			}

			.chart-container {
				height: 300px;
				padding: 15px;
			}

			.trend-wrapper {
				flex-direction: column;
				gap: 15px;
			}

			.selector-wrapper {
				width: 100%;
				min-width: unset;
			}

			#companySelect {
				width: 100%;
			}

			/* T-Account 모바일 */
			.t-account-container {
				grid-template-columns: 1fr;
				padding: 20px;
			}

			.t-divider {
				display: none;
			}

			.t-group-wrapper {
				grid-template-columns: 1fr;
			}

			.t-column {
				margin-bottom: 20px;
			}
		}

		@media (max-width: 480px) {
			body {
				padding: 5px;
			}

			.container {
				padding: 15px;
			}

			h1 {
				font-size: 20px;
			}

			.chart-container {
				height: 250px;
				padding: 10px;
			}

			.view-btn {
				font-size: 12px;
				padding: 8px 12px;
			}

			select {
				font-size: 13px;
			}
		}
	</style>
</head>
<body>
	<div class="container">
		<header>
			<div class="search-wrapper">
				<input type="text" id="companySearch" placeholder="🔍 종목 검색 (예: 삼성전자, SK하이닉스...)" autocomplete="off">
				<span class="search-icon">🔍</span>
				<div id="searchResults" class="search-results"></div>
			</div>
			<div class="header-center">
				<h1>📊 재무제표 분석 대시보드</h1>
				<p style="color: #7f8c8d;">Financial Statement Analysis Dashboard - Powered by Supabase</p>
			</div>
			<div style="min-width: 280px; display: flex; justify-content: flex-end;">
				<button onclick="goToIndex()" style="padding: 12px 25px; font-size: 14px; font-weight: bold; border: 2px solid #667eea; border-radius: 50px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transition: all 0.3s;">
					📋 종목 리스트
				</button>
			</div>
		</header>

		<div class="controls">
			<button class="view-btn active" onclick="switchView('trend')">📈 매출/영업이익 추이</button>
			<button class="view-btn" onclick="switchView('income')">📋 연간 손익계산서</button>
			<button class="view-btn" onclick="switchView('quarterlyIncome')">🗓️ 분기 손익계산서</button>
			<button class="view-btn" onclick="switchView('balance')">⚖️ 재무상태표</button>
			<button class="view-btn" onclick="switchView('cashflow')">💧 현금흐름</button>
		</div>

		<!-- 추이 차트 -->
		<div id="trendView" class="view-content active">
			<div class="trend-wrapper">
				<div class="selector-wrapper">
					<label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">종목 선택</label>
					<select id="companySelect" onchange="changeCompany()" style="width: 100%; padding: 10px 15px; font-size: 14px; border: 2px solid #667eea; border-radius: 10px; background: white; cursor: pointer;">
						<option value="">-- 종목을 선택하세요 --</option>
					</select>
				</div>
				<div class="selector-wrapper">
					<label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">기간 선택</label>
					<select id="quarterSelect" onchange="updateTrendChart()" style="width: 100%; padding: 10px 15px; font-size: 14px; border: 2px solid #667eea; border-radius: 10px; background: white; cursor: pointer;">
						<option value="annual">연간</option>
						<option value="1">1분기</option>
						<option value="2">2분기</option>
						<option value="3">3분기</option>
					</select>
				</div>
				<div class="chart-wrapper">
					<div class="chart-container">
						<canvas id="trendChart"></canvas>
					</div>
				</div>
			</div>
		</div>

		<!-- 연간 손익계산서 T-Account -->
		<div id="incomeView" class="view-content">
			<div id="incomeStatement" class="loading">데이터 로딩 중...</div>
		</div>

		<!-- 분기 손익계산서 T-Account -->
		<div id="quarterlyIncomeView" class="view-content">
			<div id="quarterlyIncomeStatement" class="loading">데이터 로딩 중...</div>
		</div>

		<!-- 재무상태표 T-Account -->
		<div id="balanceView" class="view-content">
			<div id="balanceSheet" class="loading">데이터 로딩 중...</div>
		</div>

		<!-- 현금흐름 -->
		<div id="cashflowView" class="view-content">
			<div class="chart-container">
				<canvas id="cashflowChart"></canvas>
			</div>
		</div>

		<div style="text-align: center; margin-top: 30px; color: #7f8c8d; font-size: 14px;">
			<p>📡 데이터 출처: 금융감독원 전자공시시스템 (DART) via Supabase</p>
		</div>
	</div>

	<script>
		// Supabase 클라이언트 초기화
		const SUPABASE_URL = 'https://tnkcxygqguxgiwnqsrcd.supabase.co';
		const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRua2N4eWdxZ3V4Z2l3bnFzcmNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzMxNjYsImV4cCI6MjA3NjIwOTE2Nn0.w3U5zwSslhB4yi0Xp0C-dRymLYkuA7P1Tv9VXRMdCI4';
		const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

		let charts = {};
		let companies = [];
		let currentCompanyCode = null;
		let currentCompanyName = null;
		let allCompanyData = {};

		Chart.register(ChartDataLabels);

		// 기업 목록 로드
		async function loadCompanies() {
			const { data, error } = await supabase
				.from('companies')
				.select('*')
				.order('corp_name');

			if (error) {
				console.error('기업 목록 로드 실패:', error);
				return [];
			}

			return data.map(company => ({
				name: company.corp_name,
				code: company.corp_code,
				stock: company.stock_code,
				sector: company.sector
			}));
		}

		// 손익계산서 데이터 로드 (연간 + 분기)
		async function loadIncomeStatements(corpCode) {
			const { data, error } = await supabase
				.from('income_statements')
				.select('*')
				.eq('corp_code', corpCode)
				.order('year');

			if (error) {
				console.error('손익계산서 로드 실패:', error);
				return [];
			}

			return data.map(d => ({
				year: d.year,
				report_type: d.report_type,
				revenue: d.revenue || 0,
				cost_of_sales: d.cost_of_sales || 0,
				gross_profit: d.gross_profit || 0,
				selling_admin_expenses: d.selling_admin_expenses || 0,
				operating_profit: d.operating_profit || 0,
				operating_margin: d.operating_margin || 0
			}));
		}

		// 재무상태표 데이터 로드
		async function loadBalanceSheets(corpCode) {
			const { data, error } = await supabase
				.from('balance_sheets')
				.select('*')
				.eq('corp_code', corpCode)
				.eq('report_type', '11011')
				.order('year', { ascending: false })
				.limit(1);

			if (error) {
				console.error('재무상태표 로드 실패:', error);
				return null;
			}

			return data[0] || null;
		}

		// 현금흐름 데이터 로드
		async function loadCashFlows(corpCode) {
			const { data, error } = await supabase
				.from('cash_flows')
				.select('*')
				.eq('corp_code', corpCode)
				.eq('report_type', '11011')
				.order('year');

			if (error) {
				console.error('현금흐름 로드 실패:', error);
				return [];
			}

			return data.map(d => ({
				period: d.year + '년',
				operating_cf: d.operating_cash_flow || 0,
				investing_cf: d.investing_cash_flow || 0,
				financing_cf: d.financing_cash_flow || 0
			}));
		}

		// 검색 기능
		const searchInput = document.getElementById('companySearch');
		const searchResults = document.getElementById('searchResults');

		searchInput.addEventListener('input', (e) => {
			const query = e.target.value.trim().toLowerCase();

			if (query.length === 0) {
				searchResults.classList.remove('show');
				return;
			}

			const filtered = companies.filter(company =>
				company.name.toLowerCase().includes(query) ||
				company.stock.includes(query) ||
				company.sector.toLowerCase().includes(query)
			);

			if (filtered.length === 0) {
				searchResults.innerHTML = '<div class="no-results">검색 결과가 없습니다</div>';
				searchResults.classList.add('show');
				return;
			}

			searchResults.innerHTML = filtered.map(company => `
				<div class="search-result-item" onclick="selectCompany('${company.code}', '${company.name}')">
					<div class="company-name">${company.name}</div>
					<div class="company-info">${company.stock} | ${company.sector}</div>
				</div>
			`).join('');

			searchResults.classList.add('show');
		});

		// 검색창 외부 클릭 시 결과 닫기
		document.addEventListener('click', (e) => {
			if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
				searchResults.classList.remove('show');
			}
		});

		// 종목 선택
		async function selectCompany(code, name) {
			searchResults.classList.remove('show');
			searchInput.value = name;
			currentCompanyCode = code;
			currentCompanyName = name;

			// 드롭다운도 해당 종목으로 설정
			const select = document.getElementById('companySelect');
			select.value = code;

			// 데이터 로드
			console.log(`${name} 데이터 로딩 중...`);
			const incomeData = await loadIncomeStatements(code);
			const balanceData = await loadBalanceSheets(code);
			const cashflowData = await loadCashFlows(code);

			if (incomeData.length === 0) {
				alert(`${name} 데이터가 없습니다.`);
				return;
			}

			allCompanyData[code] = {
				income: incomeData,
				balance: balanceData,
				cashflow: cashflowData
			};

			// 차트 업데이트
			updateChartsForCompany(code, name);
		}

		function updateChartsForCompany(code, name) {
			const data = allCompanyData[code];
			if (!data || !data.income || data.income.length === 0) return;

			const annualData = data.income.filter(d => d.report_type === '11011');
			const quarterlyData = data.income.filter(d => d.report_type !== '11011');

			// 추이 차트 업데이트
			renderTrendChart(data.income, name, document.getElementById('quarterSelect').value);

			// 손익계산서 T-Account 업데이트
			const latestIncome = annualData[annualData.length - 1];
			renderIncomeStatement(latestIncome, name);

			// 분기 손익계산서 업데이트
			renderQuarterlyIncomeStatement(quarterlyData, name);

			// 재무상태표 T-Account 업데이트
			renderBalanceSheet(data.balance, name);

			// 현금흐름 차트 업데이트 (Stacked bars)
			renderCashflowChart(data.cashflow, name);
		}

		function renderTrendChart(incomeData, companyName, selectedQuarter) {
			let filteredData = [];
			if (selectedQuarter === 'annual') {
				filteredData = incomeData.filter(d => d.report_type === '11011');
			} else {
				filteredData = incomeData.filter(d => d.report_type !== '11011' && d.quarter == selectedQuarter);
			}

			const ctx = document.getElementById('trendChart').getContext('2d');
			if (charts.trend) charts.trend.destroy();

			const labels = filteredData.map(d => d.year + '년' + (d.quarter ? ` ${d.quarter}분기` : ''));
			const revenues = filteredData.map(d => d.revenue / 1000000000000);
			const profits = filteredData.map(d => d.operating_profit / 1000000000000);
			const margins = filteredData.map(d => (d.operating_profit / d.revenue * 100));

			charts.trend = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: '매출 (조원)',
						data: revenues,
						backgroundColor: 'rgba(102, 126, 234, 0.7)',
						borderColor: 'rgba(102, 126, 234, 1)',
						borderWidth: 2,
						borderRadius: 8,
						yAxisID: 'y'
					}, {
						label: '영업이익 (조원)',
						data: profits,
						type: 'line',
						borderColor: 'rgba(255, 99, 132, 1)',
						backgroundColor: 'rgba(255, 99, 132, 0.2)',
						borderWidth: 3,
						pointRadius: 6,
						tension: 0.4,
						yAxisID: 'y'
					}, {
						label: '영업이익률 (%)',
						data: margins,
						type: 'line',
						borderColor: 'rgba(46, 204, 113, 1)',
						backgroundColor: 'rgba(46, 204, 113, 0.1)',
						borderWidth: 3,
						borderDash: [5, 5],
						pointRadius: 8,
						tension: 0.4,
						yAxisID: 'y1'
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						title: { display: true, text: `${companyName} 매출 및 영업이익 추이 (${filteredData.length}개 기간)`, font: { size: 18 } },
						legend: { display: true, position: 'top' },
						datalabels: {
							display: false
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							title: { display: true, text: '금액 (조원)' }
						},
						y1: {
							position: 'right',
							beginAtZero: true,
							title: { display: true, text: '영업이익률 (%)' },
							grid: { drawOnChartArea: false }
						}
					}
				}
			});
		}

		function updateTrendChart() {
			if (!currentCompanyCode || !allCompanyData[currentCompanyCode]) return;
			const data = allCompanyData[currentCompanyCode];
			renderTrendChart(data.income, currentCompanyName, document.getElementById('quarterSelect').value);
		}

			// 손익계산서 T-Account 업데이트
			const latestIncome = annualData[annualData.length - 1];
			renderIncomeStatement(latestIncome, name);

			// 분기 손익계산서 업데이트
			renderQuarterlyIncomeStatement(quarterlyData, name);

			// 재무상태표 T-Account 업데이트
			renderBalanceSheet(data.balance, name);

			// 현금흐름 차트 업데이트 (Stacked bars)
			renderCashflowChart(data.cashflow, name);
		}

		function renderQuarterlyIncomeStatement(quarterlyData, companyName) {
			const container = document.getElementById('quarterlyIncomeStatement');

			if (!quarterlyData || quarterlyData.length === 0) {
				container.innerHTML = '<div class="loading">분기 손익계산서 데이터가 없습니다.</div>';
				return;
			}

			// 최신 분기 데이터 가져오기
			const latestQuarter = quarterlyData[quarterlyData.length - 1];
			const total = latestQuarter.revenue;
			const sellingAdminExpenses = latestQuarter.selling_admin_expenses || 0;

			// 매출원가 세부 구성 (추정 비율)
			const materialCost = latestQuarter.cost_of_sales * 0.60;
			const laborCost = latestQuarter.cost_of_sales * 0.25;
			const overheadCost = latestQuarter.cost_of_sales * 0.15;

			// 판관비 세부 구성 (추정 비율)
			const rdExpense = sellingAdminExpenses * 0.40;
			const marketingExpense = sellingAdminExpenses * 0.25;
			const personnelExpense = sellingAdminExpenses * 0.35;

			const materialHeight = (materialCost / total) * 500;
			const laborHeight = (laborCost / total) * 500;
			const overheadHeight = (overheadCost / total) * 500;

			const rdHeight = (rdExpense / total) * 500;
			const marketingHeight = (marketingExpense / total) * 500;
			const personnelHeight = (personnelExpense / total) * 500;

			const profitHeight = (latestQuarter.operating_profit / total) * 500;
			const revenueHeight = 500;

			container.innerHTML = `
				<div class="t-account-container">
					<div class="t-column">
						<div class="t-title">비용 + 영업이익</div>

						<!-- 매출원가 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>💰 매출원가</div>
								<div class="t-group-total">${(latestQuarter.cost_of_sales / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item expense" style="height: ${materialHeight}px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
										<div class="t-label">재료비</div>
										<div class="t-amount">${(materialCost / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">원재료, 부재료, 소모품 등 직접 투입 재료비용</div>
									</div>
									<div class="t-item expense" style="height: ${laborHeight}px; background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">
										<div class="t-label">노무비</div>
										<div class="t-amount">${(laborCost / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">생산직 근로자 급여, 상여금, 퇴직급여 등</div>
									</div>
									<div class="t-item expense" style="height: ${overheadHeight}px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
										<div class="t-label">제조경비</div>
										<div class="t-amount">${(overheadCost / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">감가상각비, 수선비, 전력비, 기타 제조 관련 경비</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 판매관리비 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>📊 판매관리비</div>
								<div class="t-group-total">${(sellingAdminExpenses / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item expense" style="height: ${rdHeight}px; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
										<div class="t-label">연구개발비</div>
										<div class="t-amount">${(rdExpense / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">신제품 연구, 기술 개발, 연구소 운영비 등</div>
									</div>
									<div class="t-item expense" style="height: ${marketingHeight}px; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);">
										<div class="t-label">광고선전비</div>
										<div class="t-amount">${(marketingExpense / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">광고, 마케팅, 판촉, 브랜딩 활동 비용</div>
									</div>
									<div class="t-item expense" style="height: ${personnelHeight}px; background: linear-gradient(135deg, #7f8c8d 0%, #6c7a89 100%);">
										<div class="t-label">인건비</div>
										<div class="t-amount">${(personnelExpense / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">사무직/영업직 급여, 복리후생비, 교육훈련비 등</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 영업이익 -->
						<div class="t-item profit" style="height: ${profitHeight}px;">
							<div class="t-label">💚 영업이익</div>
							<div class="t-amount">${(latestQuarter.operating_profit / 1000000000000).toFixed(1)}조</div>
							<div class="t-caption">매출총이익에서 판매관리비를 뺀 본업의 수익성 지표</div>
						</div>
					</div>
					<div class="t-divider"></div>
					<div class="t-column">
						<div class="t-title">매출</div>
						<div class="t-item revenue" style="height: ${revenueHeight}px;">
							<div class="t-label">💙 영업수익</div>
							<div class="t-amount">${(latestQuarter.revenue / 1000000000000).toFixed(1)}조</div>
							<div class="t-caption">제품 및 서비스 판매로 얻은 총 수익 (${latestQuarter.year}년 ${latestQuarter.quarter}분기)</div>
						</div>
					</div>
				</div>
			`;
		}

		function renderIncomeStatement(data, companyName) {
			if (!data) return;

			const container = document.getElementById('incomeStatement');
			const total = data.revenue;
			const sellingAdminExpenses = data.selling_admin_expenses || 0;

			// 매출원가 세부 구성 (추정 비율)
			const materialCost = data.cost_of_sales * 0.60;
			const laborCost = data.cost_of_sales * 0.25;
			const overheadCost = data.cost_of_sales * 0.15;

			// 판관비 세부 구성 (추정 비율)
			const rdExpense = sellingAdminExpenses * 0.40;
			const marketingExpense = sellingAdminExpenses * 0.25;
			const personnelExpense = sellingAdminExpenses * 0.35;

			const materialHeight = (materialCost / total) * 500;
			const laborHeight = (laborCost / total) * 500;
			const overheadHeight = (overheadCost / total) * 500;

			const rdHeight = (rdExpense / total) * 500;
			const marketingHeight = (marketingExpense / total) * 500;
			const personnelHeight = (personnelExpense / total) * 500;

			const profitHeight = (data.operating_profit / total) * 500;
			const revenueHeight = 500;

			container.innerHTML = `
				<div class="t-account-container">
					<div class="t-column">
						<div class="t-title">비용 + 영업이익</div>

						<!-- 매출원가 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>💰 매출원가</div>
								<div class="t-group-total">${(data.cost_of_sales / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item expense" style="height: ${materialHeight}px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
										<div class="t-label">재료비</div>
										<div class="t-amount">${(materialCost / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">원재료, 부재료, 소모품 등 직접 투입 재료비용</div>
									</div>
									<div class="t-item expense" style="height: ${laborHeight}px; background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">
										<div class="t-label">노무비</div>
										<div class="t-amount">${(laborCost / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">생산직 근로자 급여, 상여금, 퇴직급여 등</div>
									</div>
									<div class="t-item expense" style="height: ${overheadHeight}px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
										<div class="t-label">제조경비</div>
										<div class="t-amount">${(overheadCost / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">감가상각비, 수선비, 전력비, 기타 제조 관련 경비</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 판매관리비 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>📊 판매관리비</div>
								<div class="t-group-total">${(sellingAdminExpenses / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item expense" style="height: ${rdHeight}px; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
										<div class="t-label">연구개발비</div>
										<div class="t-amount">${(rdExpense / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">신제품 연구, 기술 개발, 연구소 운영비 등</div>
									</div>
									<div class="t-item expense" style="height: ${marketingHeight}px; background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);">
										<div class="t-label">광고선전비</div>
										<div class="t-amount">${(marketingExpense / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">광고, 마케팅, 판촉, 브랜딩 활동 비용</div>
									</div>
									<div class="t-item expense" style="height: ${personnelHeight}px; background: linear-gradient(135deg, #7f8c8d 0%, #6c7a89 100%);">
										<div class="t-label">인건비</div>
										<div class="t-amount">${(personnelExpense / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">사무직/영업직 급여, 복리후생비, 교육훈련비 등</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 영업이익 -->
						<div class="t-item profit" style="height: ${profitHeight}px;">
							<div class="t-label">💚 영업이익</div>
							<div class="t-amount">${(data.operating_profit / 1000000000000).toFixed(1)}조</div>
							<div class="t-caption">매출총이익에서 판매관리비를 뺀 본업의 수익성 지표</div>
						</div>
					</div>
					<div class="t-divider"></div>
					<div class="t-column">
						<div class="t-title">매출</div>
						<div class="t-item revenue" style="height: ${revenueHeight}px;">
							<div class="t-label">💙 영업수익</div>
							<div class="t-amount">${(data.revenue / 1000000000000).toFixed(1)}조</div>
							<div class="t-caption">제품 및 서비스 판매로 얻은 총 수익 (${data.year}년)</div>
						</div>
					</div>
				</div>
			`;
		}

		function renderBalanceSheet(data, companyName) {
			const container = document.getElementById('balanceSheet');

			if (!data) {
				container.innerHTML = '<div class="loading">재무상태표 데이터가 없습니다.</div>';
				return;
			}

			const total = data.total_assets;

			const currentAssets = data.current_assets;
			const nonCurrentAssets = data.non_current_assets;
			const currentLiab = data.current_liabilities;
			const nonCurrentLiab = data.non_current_liabilities;
			const equity = data.total_equity;

			// 유동자산 세부 (추정 비율)
			const cash = currentAssets * 0.30;
			const receivables = currentAssets * 0.35;
			const inventory = currentAssets * 0.25;
			const otherCA = currentAssets - cash - receivables - inventory;

			// 비유동자산 세부 (추정 비율)
			const ppe = nonCurrentAssets * 0.50;
			const intangible = nonCurrentAssets * 0.20;
			const investments = nonCurrentAssets - ppe - intangible;

			// 부채 및 자본 세부 (추정 비율)
			const payables = currentLiab * 0.40;
			const shortDebt = currentLiab * 0.30;
			const otherCL = currentLiab - payables - shortDebt;

			const longDebt = nonCurrentLiab * 0.60;
			const otherNCL = nonCurrentLiab - longDebt;

			const paidInCapital = equity * 0.10;
			const retainedEarnings = equity * 0.85;
			const otherEquity = equity - paidInCapital - retainedEarnings;

			const cashHeight = (cash / total) * 500;
			const receivablesHeight = (receivables / total) * 500;
			const inventoryHeight = (inventory / total) * 500;
			const otherCAHeight = (otherCA / total) * 500;

			const ppeHeight = (ppe / total) * 500;
			const intangibleHeight = (intangible / total) * 500;
			const investmentsHeight = (investments / total) * 500;

			const payablesHeight = (payables / total) * 500;
			const shortDebtHeight = (shortDebt / total) * 500;
			const otherCLHeight = (otherCL / total) * 500;

			const longDebtHeight = (longDebt / total) * 500;
			const otherNCLHeight = (otherNCL / total) * 500;

			const paidInHeight = (paidInCapital / total) * 500;
			const retainedHeight = (retainedEarnings / total) * 500;
			const otherEqHeight = (otherEquity / total) * 500;

			container.innerHTML = `
				<div class="t-account-container">
					<div class="t-column">
						<div class="t-title">자산 (Assets)</div>

						<!-- 유동자산 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>💵 유동자산</div>
								<div class="t-group-total">${(currentAssets / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item" style="height: ${cashHeight}px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
										<div class="t-label">현금및현금성자산</div>
										<div class="t-amount">${(cash / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">즉시 사용 가능한 현금, 당좌예금, 보통예금 등</div>
									</div>
									<div class="t-item" style="height: ${receivablesHeight}px; background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);">
										<div class="t-label">매출채권</div>
										<div class="t-amount">${(receivables / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">제품 판매 대금 미수금</div>
									</div>
									<div class="t-item" style="height: ${inventoryHeight}px; background: linear-gradient(135deg, #85c1e9 0%, #5dade2 100%);">
										<div class="t-label">재고자산</div>
										<div class="t-amount">${(inventory / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">제품, 반제품, 원재료</div>
									</div>
									<div class="t-item" style="height: ${otherCAHeight}px; background: linear-gradient(135deg, #aed6f1 0%, #85c1e9 100%);">
										<div class="t-label">기타유동자산</div>
										<div class="t-amount">${(otherCA / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">선급비용, 미수수익 등</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 비유동자산 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>🏢 비유동자산</div>
								<div class="t-group-total">${(nonCurrentAssets / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item" style="height: ${ppeHeight}px; background: linear-gradient(135deg, #2980b9 0%, #1f6391 100%);">
										<div class="t-label">유형자산</div>
										<div class="t-amount">${(ppe / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">토지, 건물, 기계장치, 차량</div>
									</div>
									<div class="t-item" style="height: ${intangibleHeight}px; background: linear-gradient(135deg, #21618c 0%, #1a5276 100%);">
										<div class="t-label">무형자산</div>
										<div class="t-amount">${(intangible / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">특허권, 상표권, 영업권</div>
									</div>
									<div class="t-item" style="height: ${investmentsHeight}px; background: linear-gradient(135deg, #1a5276 0%, #154360 100%);">
										<div class="t-label">투자자산</div>
										<div class="t-amount">${(investments / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">장기금융상품, 투자부동산</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="t-divider"></div>
					<div class="t-column">
						<div class="t-title">부채 + 자본</div>

						<!-- 유동부채 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>📛 유동부채</div>
								<div class="t-group-total">${(currentLiab / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item" style="height: ${payablesHeight}px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
										<div class="t-label">매입채무</div>
										<div class="t-amount">${(payables / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">원재료 구매 대금 미지급금</div>
									</div>
									<div class="t-item" style="height: ${shortDebtHeight}px; background: linear-gradient(135deg, #ec7063 0%, #e74c3c 100%);">
										<div class="t-label">단기차입금</div>
										<div class="t-amount">${(shortDebt / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">1년 내 상환 차입금</div>
									</div>
									<div class="t-item" style="height: ${otherCLHeight}px; background: linear-gradient(135deg, #f1948a 0%, #ec7063 100%);">
										<div class="t-label">기타유동부채</div>
										<div class="t-amount">${(otherCL / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">미지급비용, 선수금 등</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 비유동부채 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>📕 비유동부채</div>
								<div class="t-group-total">${(nonCurrentLiab / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item" style="height: ${longDebtHeight}px; background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);">
										<div class="t-label">장기차입금</div>
										<div class="t-amount">${(longDebt / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">1년 이상 장기 차입금</div>
									</div>
									<div class="t-item" style="height: ${otherNCLHeight}px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
										<div class="t-label">기타비유동부채</div>
										<div class="t-amount">${(otherNCL / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">퇴직급여충당부채 등</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 자본 그룹 -->
						<div class="t-group-wrapper">
							<div class="t-group-label">
								<div>💚 자본</div>
								<div class="t-group-total">${(equity / 1000000000000).toFixed(1)}조원</div>
							</div>
							<div class="t-group">
								<div class="t-group-content">
									<div class="t-item" style="height: ${paidInHeight}px; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
										<div class="t-label">자본금+자본잉여금</div>
										<div class="t-amount">${(paidInCapital / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">주주 출자금, 주식발행초과금</div>
									</div>
									<div class="t-item" style="height: ${retainedHeight}px; background: linear-gradient(135deg, #58d68d 0%, #2ecc71 100%);">
										<div class="t-label">이익잉여금</div>
										<div class="t-amount">${(retainedEarnings / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">누적 순이익 미배당액</div>
									</div>
									<div class="t-item" style="height: ${otherEqHeight}px; background: linear-gradient(135deg, #82e0aa 0%, #58d68d 100%);">
										<div class="t-label">기타자본</div>
										<div class="t-amount">${(otherEquity / 1000000000000).toFixed(1)}조</div>
										<div class="t-caption">기타포괄손익누계액 등</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			`;
		}

		function renderCashflowChart(cashflowData, companyName) {
			const ctx = document.getElementById('cashflowChart').getContext('2d');
			if (charts.cashflow) charts.cashflow.destroy();

			if (!cashflowData || cashflowData.length === 0) {
				document.getElementById('cashflowView').querySelector('.chart-container').innerHTML =
					'<div class="loading">현금흐름 데이터가 없습니다.</div>';
				return;
			}

			const labels = cashflowData.map(d => d.period);
			const operatingCF = cashflowData.map(d => d.operating_cf / 1000000000000);
			const investingCF = cashflowData.map(d => d.investing_cf / 1000000000000);
			const financingCF = cashflowData.map(d => d.financing_cf / 1000000000000);

			charts.cashflow = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [
						{
							label: '영업활동',
							data: operatingCF,
							backgroundColor: 'rgba(54, 162, 235, 0.8)'
						},
						{
							label: '투자활동',
							data: investingCF,
							backgroundColor: 'rgba(255, 99, 132, 0.8)'
						},
						{
							label: '재무활동',
							data: financingCF,
							backgroundColor: 'rgba(75, 192, 192, 0.8)'
						}
					]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						title: { display: true, text: `${companyName} 현금흐름 (세로 적층)`, font: { size: 18 } },
						legend: { display: true, position: 'top' },
						datalabels: { display: false }
					},
					scales: {
						x: {
							stacked: true
						},
						y: {
							stacked: true,
							title: { display: true, text: '금액 (조원)' }
						}
					}
				}
			});
		}

		function populateCompanySelect() {
			const select = document.getElementById('companySelect');
			companies.forEach(company => {
				const option = document.createElement('option');
				option.value = company.code;
				option.textContent = `${company.name} (${company.stock})`;
				select.appendChild(option);
			});
		}

		function changeCompany() {
			const select = document.getElementById('companySelect');
			const selectedCode = select.value;
			if (!selectedCode) return;

			const company = companies.find(c => c.code === selectedCode);
			if (company) {
				selectCompany(company.code, company.name);
			}
		}

		function switchView(view) {
			document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
			event.target.classList.add('active');
			document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
			document.getElementById(view + 'View').classList.add('active');
		}

		function goToIndex() {
			window.location.href = 'index.html';
		}

		// 데이터 로드
		async function loadData() {
			try {
				// 기업 목록 로드
				companies = await loadCompanies();
				populateCompanySelect();

				// 기본 삼성전자 데이터 로드
				const samsung = companies.find(c => c.code === '00126380');
				if (samsung) {
					searchInput.value = samsung.name;
					await selectCompany(samsung.code, samsung.name);
				}
			} catch (error) {
				console.error('데이터 로드 실패:', error);
			}
		}

		window.addEventListener('load', loadData);
	</script>
</body>
</html>
