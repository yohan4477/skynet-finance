<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ì¬ë¬´ì œí‘œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<style>
			* { margin: 0; padding: 0; box-sizing: border-box; }
	
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
				background: #f8f9fa; /* Light gray background */
				color: #212529; /* Dark text */
				min-height: 100vh;
				padding: 0;
			}
	
			.container {
				max-width: 1400px;
				margin: 0 auto;
				padding: 20px;
			}
	
			/* Header */
			header {
				background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); /* Brighter blue gradient */
				padding: 30px 20px;
				margin-bottom: 20px;
				border-radius: 16px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
			}
	
			.header-content {
				max-width: 1400px;
				margin: 0 auto;
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 20px;
			}
	
			h1 {
				color: white;
				font-size: 28px;
				font-weight: 700;
				display: flex;
				align-items: center;
				gap: 10px;
			}
	
			.search-box {
				flex: 1;
				max-width: 500px;
				position: relative;
			}
	
			#companySearch {
				width: 100%;
				padding: 14px 45px 14px 20px;
				font-size: 16px;
				border: 1px solid #dee2e6;
				border-radius: 50px;
				background: white;
				outline: none;
				transition: all 0.3s;
			}
	
			#companySearch:focus {
				border-color: #4e73df;
				box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.2);
			}
	
			.search-icon {
				position: absolute;
				right: 20px;
				top: 50%;
				transform: translateY(-50%);
				font-size: 20px;
				color: #6c757d;
			}
	
			.search-results {
				position: absolute;
				top: 100%;
				left: 0;
				right: 0;
				background: white;
				border-radius: 16px;
				margin-top: 8px;
				max-height: 400px;
				overflow-y: auto;
				box-shadow: 0 20px 40px rgba(0,0,0,0.15);
				z-index: 1000;
				display: none;
			}
	
			.search-results.show { display: block; }
	
			.search-result-item {
				padding: 16px 20px;
				cursor: pointer;
				border-bottom: 1px solid #f1f5f9;
				transition: all 0.2s;
			}
	
			.search-result-item:hover {
				background: #4e73df;
				color: white;
			}
	
			.company-name {
				font-weight: 700;
				font-size: 16px;
				margin-bottom: 4px;
				color: #343a40;
			}
	
			.search-result-item:hover .company-name {
				color: white;
			}
	
			.company-info {
				font-size: 13px;
				color: #6c757d;
			}
	
			.search-result-item:hover .company-info {
				color: rgba(255,255,255,0.8);
			}
	
			/* Controls */
			.controls {
				display: flex;
				gap: 12px;
				margin-bottom: 20px;
				flex-wrap: wrap;
			}
	
			.view-btn {
				padding: 14px 28px;
				font-size: 15px;
				font-weight: 600;
				border: 2px solid #dee2e6;
				border-radius: 12px;
				cursor: pointer;
				background: #ffffff;
				color: #495057;
				transition: all 0.3s;
			}
	
			.view-btn:hover {
				background: #f8f9fa;
				border-color: #adb5bd;
			}
	
			.view-btn.active {
				background: #4e73df;
				color: white;
				border-color: transparent;
				box-shadow: 0 4px 12px rgba(78, 115, 223, 0.3);
			}
	
			/* Content Card */
			.content-card {
				background: #ffffff;
				border-radius: 16px;
				padding: 30px;
				box-shadow: 0 10px 30px rgba(0,0,0,0.05);
				margin-bottom: 20px;
				border: 1px solid #e9ecef;
			}
	
			.view-content { display: none; }
			.view-content.active { display: block; animation: fadeIn 0.4s; }
	
			@keyframes fadeIn {
				from { opacity: 0; transform: translateY(10px); }
				to { opacity: 1; transform: translateY(0); }
			}
	
			/* Trend Section */
			.trend-controls {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 20px;
				margin-bottom: 20px;
			}
	
			.control-group label {
				display: block;
				margin-bottom: 8px;
				font-weight: 600;
				color: #495057;
				font-size: 14px;
			}
	
			select {
				width: 100%;
				padding: 12px 16px;
				font-size: 15px;
				border: 2px solid #dee2e6;
				border-radius: 10px;
				background: #ffffff;
				color: #495057;
				cursor: pointer;
				transition: all 0.3s;
			}
	
			select:focus {
				outline: none;
				border-color: #4e73df;
				box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
			}
	
			.chart-container {
				height: 500px;
				background: #f8f9fa;
				padding: 20px;
				border-radius: 12px;
				border: 1px solid #e9ecef;
			}
	
			/* T-Account - Modern Grid Layout */
			.t-account-wrapper {
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
			}
	
			.t-account-container {
				display: grid;
				grid-template-columns: 1fr auto 1fr;
				gap: 20px;
				min-width: 800px;
				padding: 20px;
				background: #f8f9fa;
				border-radius: 12px;
				border: 1px solid #e9ecef;
			}
	
			.t-column {
				display: flex;
				flex-direction: column;
				gap: 12px;
			}
	
			.t-divider {
				width: 2px;
				background: #dee2e6;
				border-radius: 1px;
			}
	
			.t-title {
				text-align: center;
				font-size: 20px;
				font-weight: 700;
				color: #343a40;
				padding: 12px;
				background: #f1f3f5;
				border-radius: 10px;
				margin-bottom: 8px;
			}
	
			.t-group {
				background: #ffffff;
				border-radius: 10px;
				padding: 16px;
				border: 2px solid #e9ecef;
			}
	
			.t-group-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 12px;
				background: #4e73df;
				border-radius: 8px;
				margin-bottom: 12px;
			}
	
			.t-group-title {
				font-size: 14px;
				font-weight: 700;
				color: white;
			}
	
			.t-group-total {
				font-size: 15px;
				font-weight: 700;
				color: white;
			}
	
			.t-item {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 12px 16px;
				background: #f8f9fa;
				border-radius: 8px;
				margin-bottom: 8px;
				transition: all 0.2s;
				cursor: pointer;
				border: 1px solid #e9ecef;
			}
	
			.t-item:hover {
				transform: translateX(4px);
				box-shadow: 0 4px 12px rgba(0,0,0,0.1);
			}
	
			.t-item.expense {
				background: #ffe3e3;
				border-color: #fabdbd;
			}
	
			.t-item.profit {
				background: #d1fae5;
				border-color: #a7f3d0;
			}
	
			.t-item.revenue {
				background: #dbeafe;
				border-color: #bfdbfe;
			}
	
			.t-item.asset {
				background: #cffafe;
				border-color: #a5f3fc;
			}
	
			.t-item.liability {
				background: #ffedd5;
				border-color: #fed7aa;
			}
			
			.t-item.equity {
				background: #e9d5ff;
				border-color: #d8b4fe;
			}
	
			.t-label {
				font-size: 14px;
				font-weight: 600;
				color: #495057;
			}
	
			.t-amount {
				font-size: 15px;
				font-weight: 700;
				color: #212529;
			}
	
			.loading {
				text-align: center;
				padding: 60px;
				color: #6c757d;
				font-size: 16px;
			}
	
			/* Mobile Responsive */
			@media (max-width: 768px) {
				.container {
					padding: 10px;
				}
	
				header {
					padding: 20px 15px;
				}
	
				.header-content {
					flex-direction: column;
				}
	
				h1 {
					font-size: 22px;
				}
	
				.search-box {
					width: 100%;
					max-width: 100%;
				}
	
				.controls {
					flex-direction: column;
				}
	
				.view-btn {
					width: 100%;
					font-size: 14px;
					padding: 12px 20px;
				}
	
				.content-card {
					padding: 20px 15px;
				}
	
				.trend-controls {
					grid-template-columns: 1fr;
				}
	
				.chart-container {
					height: 350px;
					padding: 15px;
				}
	
				.t-account-container {
					min-width: 700px;
					padding: 15px;
					gap: 15px;
				}
	
				.t-title {
					font-size: 16px;
				}
	
				.t-group-header {
					padding: 10px;
				}
	
				.t-group-title {
					font-size: 12px;
				}
				
				.t-group-total {
					font-size: 13px;
				}
	
				.t-label {
					font-size: 12px;
				}
	
				.t-amount {
					font-size: 13px;
				}
			}
	
			/* Footer */
			.footer {
				text-align: center;
				padding: 20px;
				color: #6c757d;
				font-size: 14px;
			}
		</style>
</head>
<body>
	<header>
		<div class="header-content">
			<h1>ğŸ“Š ì¬ë¬´ì œí‘œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
			<div class="search-box">
				<input type="text" id="companySearch" placeholder="ì¢…ëª© ê²€ìƒ‰ (ì˜ˆ: ì‚¼ì„±ì „ì, LGì—ë„ˆì§€ì†”ë£¨ì…˜...)" autocomplete="off">
				<span class="search-icon">ğŸ”</span>
				<div id="searchResults" class="search-results"></div>
			</div>
		</div>
	</header>

	<div class="container">
		<div class="trend-controls">
			<div class="control-group">
				<label>ì¢…ëª© ì„ íƒ</label>
				<select id="companySelect" onchange="changeCompany()">
					<option value="">-- ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš” --</option>
				</select>
			</div>
			<div class="control-group">
				<label>ê¸°ê°„ ì„ íƒ</label>
				<select id="quarterSelect" onchange="updateAllViews()">
					<option value="annual">ì—°ê°„</option>
					<option value="quarterly">ë¶„ê¸°</option>
				</select>
			</div>
		</div>

		<div class="controls">
			<button class="view-btn active" onclick="switchView('trend')">ğŸ“ˆ ì¶”ì´ ë¶„ì„</button>
			<button class="view-btn" onclick="switchView('income')">ğŸ“‹ ì†ìµê³„ì‚°ì„œ</button>
			<button class="view-btn" onclick="switchView('balance')">âš–ï¸ ì¬ë¬´ìƒíƒœí‘œ</button>
			<button class="view-btn" onclick="switchView('cashflow')">ğŸ’§ í˜„ê¸ˆíë¦„</button>
		</div>

		<!-- ì¶”ì´ ë¶„ì„ -->
		<div id="trendView" class="view-content active">
			<div class="content-card">
				<div class="chart-container">
					<canvas id="trendChart"></canvas>
				</div>
			</div>
		</div>

		<!-- ì—°ê°„ ì†ìµê³„ì‚°ì„œ -->
		<div id="incomeView" class="view-content">
			<div class="content-card">
				<div id="incomeStatement" class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
			</div>
		</div>


		<!-- ì¬ë¬´ìƒíƒœí‘œ -->
		<div id="balanceView" class="view-content">
			<div class="content-card">
				<div id="balanceSheet" class="loading">ë°ì´í„° ë¡œë”© ì¤‘...</div>
			</div>
		</div>

		<!-- í˜„ê¸ˆíë¦„ -->
		<div id="cashflowView" class="view-content">
			<div class="content-card">
				<div class="chart-container">
					<canvas id="cashflowChart"></canvas>
				</div>
			</div>
		</div>

		<div class="footer">
			<p>ğŸ“¡ ë°ì´í„° ì¶œì²˜: ê¸ˆìœµê°ë…ì› ì „ìê³µì‹œì‹œìŠ¤í…œ (DART) via Supabase</p>
		</div>
	</div>

	<script>
		// Supabase ì´ˆê¸°í™”
		const SUPABASE_URL = 'https://tnkcxygqguxgiwnqsrcd.supabase.co';
		const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRua2N4eWdxZ3V4Z2l3bnFzcmNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzMxNjYsImV4cCI6MjA3NjIwOTE2Nn0.w3U5zwSslhB4yi0Xp0C-dRymLYkuA7P1Tv9VXRMdCI4';
		const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

		let charts = {};
		let companies = [];
		let currentCompanyCode = null;
		let currentCompanyName = null;
		let allCompanyData = {};

		Chart.register(ChartDataLabels);

		// Chart.js ê¸°ë³¸ ìƒ‰ìƒ ì„¤ì • (ë¼ì´íŠ¸ ëª¨ë“œ)
		Chart.defaults.color = '#666';
		Chart.defaults.borderColor = '#e0e0e0';

		async function loadCompanies() {
			const { data, error } = await supabase.from('companies').select('*').order('corp_name');
			if (error) {
				console.error('ê¸°ì—… ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
				return [];
			}
			return data.map(company => ({
				name: company.corp_name,
				code: company.corp_code,
				stock: company.stock_code,
				sector: company.sector
			}));
		}

		async function loadIncomeStatements(corpCode) {
			const { data, error } = await supabase.from('income_statements').select('*').eq('corp_code', corpCode).order('year');
			if (error) {
                console.error('Income Statement Load Error:', error);
                return [];
            }
			return data.map(d => ({
				year: d.year,
				report_type: d.report_type,
				quarter: d.report_type === '11013' ? 1 : d.report_type === '11012' ? 2 : d.report_type === '11014' ? 3 : null,
				revenue: d.revenue || 0,
				cost_of_sales: d.cost_of_sales || 0,
				gross_profit: d.gross_profit || 0,
				selling_admin_expenses: d.selling_admin_expenses || 0,
				operating_profit: d.operating_profit || 0,
				operating_margin: d.operating_margin || 0
			}));
		}

		async function loadBalanceSheets(corpCode) {
			const { data, error } = await supabase.from('balance_sheets').select('*').eq('corp_code', corpCode).eq('report_type', '11011').order('year', { ascending: false }).limit(1);
			if (error) {
                console.error('Balance Sheet Load Error:', error);
				return null;
            }
			return data[0] || null;
		}

		async function loadCashFlows(corpCode) {
			const { data, error } = await supabase.from('cash_flows').select('*').eq('corp_code', corpCode).order('year');
			if (error) {
                console.error('Cash Flow Load Error:', error);
				return [];
            }
			return data.map(d => ({
				year: d.year,
				quarter: d.report_type === '11013' ? 1 : d.report_type === '11012' ? 2 : d.report_type === '11014' ? 3 : null,
				period: d.year + 'ë…„' + (d.report_type !== '11011' ? ` Q${d.report_type === '11013' ? 1 : d.report_type === '11012' ? 2 : 3}` : ''),
				report_type: d.report_type,
				operating_cf: d.operating_cash_flow || 0,
				investing_cf: d.investing_cash_flow || 0,
				financing_cf: d.financing_cash_flow || 0
			}));
		}

		// ê²€ìƒ‰ ê¸°ëŠ¥
		const searchInput = document.getElementById('companySearch');
		const searchResults = document.getElementById('searchResults');

		searchInput.addEventListener('input', (e) => {
			const query = e.target.value.trim().toLowerCase();
			if (query.length === 0) {
				searchResults.classList.remove('show');
				return;
			}

			const filtered = companies.filter(company =>
				company.name.toLowerCase().includes(query) ||
				(company.stock && company.stock.includes(query)) ||
				(company.sector && company.sector.toLowerCase().includes(query))
			);

			if (filtered.length === 0) {
				searchResults.innerHTML = '<div class="loading">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
				searchResults.classList.add('show');
				return;
			}

			searchResults.innerHTML = filtered.map(company => `
				<div class="search-result-item" onclick="selectCompany('${company.code}', '${company.name}')">
					<div class="company-name">${company.name}</div>
					<div class="company-info">${company.stock || 'N/A'} | ${company.sector || 'N/A'}</div>
				</div>
			`).join('');

			searchResults.classList.add('show');
		});

		document.addEventListener('click', (e) => {
			if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
				searchResults.classList.remove('show');
			}
		});

		async function selectCompany(code, name) {
			searchResults.classList.remove('show');
			searchInput.value = name;
			currentCompanyCode = code;
			currentCompanyName = name;

			document.getElementById('companySelect').value = code;

			console.log(`${name} ë°ì´í„° ë¡œë”© ì¤‘...`);
			const incomeData = await loadIncomeStatements(code);
			const balanceData = await loadBalanceSheets(code);
			const cashflowData = await loadCashFlows(code);

			if (incomeData.length === 0) {
				alert(`${name}ì— ëŒ€í•œ ì†ìµê³„ì‚°ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
			}

			allCompanyData[code] = { income: incomeData, balance: balanceData, cashflow: cashflowData };
			updateAllViews();
		}

		function updateAllViews() {
			if (!currentCompanyCode || !allCompanyData[currentCompanyCode]) return;
			const data = allCompanyData[currentCompanyCode];
			const selectedPeriod = document.getElementById('quarterSelect').value;

			renderTrendChart(data.income, currentCompanyName, selectedPeriod);
			renderIncomeStatement(data.income, currentCompanyName, selectedPeriod);
			renderBalanceSheet(data.balance, currentCompanyName);
			renderCashflowChart(data.cashflow, currentCompanyName, selectedPeriod);
		}

		function renderTrendChart(incomeData, companyName, selectedPeriod) {
			let filteredData = [];
			if (selectedPeriod === 'annual') {
				filteredData = incomeData.filter(d => d.report_type === '11011' && d.revenue > 0);
			} else { // quarterly
				filteredData = incomeData
					.filter(d => d.report_type !== '11011' && d.quarter && d.revenue > 0)
					.sort((a, b) => {
						if (a.year !== b.year) return a.year - b.year;
						return a.quarter - b.quarter;
					});
			}

			const ctx = document.getElementById('trendChart').getContext('2d');
			if (charts.trend) charts.trend.destroy();

			const labels = filteredData.map(d => d.year + 'ë…„' + (d.quarter ? ` Q${d.quarter}` : ''));
			const revenues = filteredData.map(d => d.revenue / 1000000000000);
			const profits = filteredData.map(d => d.operating_profit / 1000000000000);
			const margins = filteredData.map(d => (d.operating_margin));

			charts.trend = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'ë§¤ì¶œ (ì¡°ì›)',
						data: revenues,
						backgroundColor: 'rgba(78, 115, 223, 0.8)',
						borderColor: 'rgba(78, 115, 223, 1)',
						borderWidth: 2,
						borderRadius: 8,
						yAxisID: 'y',
						order: 1
					}, {
						label: 'ì˜ì—…ì´ìµ (ì¡°ì›)',
						data: profits,
						type: 'line',
						borderColor: 'rgba(28, 200, 138, 1)',
						backgroundColor: 'rgba(28, 200, 138, 0.1)',
						borderWidth: 3,
						pointRadius: 6,
						tension: 0.4,
						yAxisID: 'y',
						order: 0
					}, {
						label: 'ì˜ì—…ì´ìµë¥  (%)',
						data: margins,
						type: 'line',
						borderColor: '#e74a3b',
						backgroundColor: 'rgba(231, 74, 59, 0.1)',
						borderWidth: 3,
						borderDash: [5, 5],
						pointRadius: 8,
						tension: 0.4,
						yAxisID: 'y1',
						order: 0,
						datalabels: {
							display: true,
							align: 'top',
							color: '#e74a3b',
							font: { weight: 'bold' },
							formatter: function(value) {
								return value.toFixed(1) + '%';
							}
						}
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						title: {
							display: true,
							text: `${companyName} ë§¤ì¶œ ë° ì˜ì—…ì´ìµ ì¶”ì´`,
							font: { size: 18 },
							color: '#343a40'
						},
						legend: { display: true, position: 'top' },
						datalabels: { display: false } // Global disable
					},
					scales: {
						y: {
							beginAtZero: true,
							title: { display: true, text: 'ê¸ˆì•¡ (ì¡°ì›)' },
							grid: { color: '#e9ecef' }
						},
						y1: {
							position: 'right',
							beginAtZero: true,
							title: { display: true, text: 'ì˜ì—…ì´ìµë¥  (%)' },
							grid: { drawOnChartArea: false, color: '#e9ecef' }
						},
						x: {
							grid: { color: '#e9ecef' }
						}
					}
				}
			});
		}

		function renderIncomeStatement(incomeData, companyName, periodType) {
			const container = document.getElementById('incomeStatement');
			let data;
			let periodLabel = '';

			if (periodType === 'annual') {
				const annualData = incomeData.filter(d => d.report_type === '11011' && d.revenue > 0);
				if(annualData.length === 0) {
					container.innerHTML = '<div class="loading">ì—°ê°„ ì†ìµê³„ì‚°ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
					return;
				}
				data = annualData[annualData.length - 1];
				periodLabel = `${data.year}ë…„`;
			} else { // quarterly
				const quarterlyData = incomeData.filter(d => d.report_type !== '11011' && d.revenue > 0).sort((a, b) => a.year - b.year || a.quarter - b.quarter);
				if(quarterlyData.length === 0) {
					container.innerHTML = '<div class="loading">ë¶„ê¸° ì†ìµê³„ì‚°ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
					return;
				}
				data = quarterlyData[quarterlyData.length - 1];
				periodLabel = `${data.year}ë…„ Q${data.quarter}`;
			}

			if (!data || !data.revenue) {
				container.innerHTML = '<div class="loading">ì„ íƒëœ ê¸°ê°„ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
				return;
			}

			// LV1: ê¸°ë³¸ í•­ëª©
			const revenue = data.revenue || 0;
			const costOfSales = data.cost_of_sales || 0;
			const grossProfit = data.gross_profit || (revenue - costOfSales);

			// LV2: ì„¸ë¶€ í•­ëª©
			const sellingAdmin = data.selling_admin_expenses || 0;
			const operatingProfit = data.operating_profit || 0;

			// ë¹„ìœ¨ ê³„ì‚° (ë§¤ì¶œ ëŒ€ë¹„)
			const costRatio = revenue > 0 ? (costOfSales / revenue * 100).toFixed(1) : 0;
			const grossProfitRatio = revenue > 0 ? (grossProfit / revenue * 100).toFixed(1) : 0;
			const sellingAdminRatio = revenue > 0 ? (sellingAdmin / revenue * 100).toFixed(1) : 0;
			const operatingProfitRatio = revenue > 0 ? (operatingProfit / revenue * 100).toFixed(1) : 0;

			container.innerHTML = `
				<div class="t-account-wrapper">
					<div class="t-account-container" style="align-items: stretch;">
						<!-- ì¢Œì¸¡: ë¹„ìš© ê³„ì¸µ êµ¬ì¡° -->
						<div class="t-column" style="flex: 1;">
							<div class="t-title">ì°¨ë³€ (ë¹„ìš© + ì´ìµ)</div>

							<!-- LV1: ë§¤ì¶œì›ê°€ -->
							<div class="t-group" style="margin-bottom: 16px;">
								<div class="t-group-header" style="background: #dc3545;">
									<span class="t-group-title">LV1 ë§¤ì¶œì›ê°€</span>
									<div>
										<span class="t-group-total">${(costOfSales / 1000000000000).toFixed(1)}ì¡°</span>
										<span style="font-size: 13px; margin-left: 8px;">${costRatio}%</span>
									</div>
								</div>
								<div style="padding: 12px; background: #fff3cd; border-radius: 8px; margin-top: 8px;">
									<div style="color: #856404; font-size: 13px;">ì„¸ë¶€ ë‚´ì—­ ì—†ìŒ (DART API ì œí•œ)</div>
								</div>
							</div>

							<!-- LV1: ë§¤ì¶œì´ì´ìµ -->
							<div class="t-group" style="margin-bottom: 16px;">
								<div class="t-group-header" style="background: #28a745;">
									<span class="t-group-title">LV1 ë§¤ì¶œì´ì´ìµ</span>
									<div>
										<span class="t-group-total">${(grossProfit / 1000000000000).toFixed(1)}ì¡°</span>
										<span style="font-size: 13px; margin-left: 8px;">${grossProfitRatio}%</span>
									</div>
								</div>

								<!-- LV2: íŒë§¤ê´€ë¦¬ë¹„ -->
								<div class="t-item expense" style="margin-top: 8px; justify-content: space-between;">
									<div>
										<div class="t-label">ğŸ“Š LV2 íŒë§¤ê´€ë¦¬ë¹„</div>
										<div class="t-amount">${(sellingAdmin / 1000000000000).toFixed(1)}ì¡°</div>
									</div>
									<div style="font-size: 14px; font-weight: 700; color: #e74a3b;">${sellingAdminRatio}%</div>
								</div>

								<!-- LV2: ì˜ì—…ì´ìµ -->
								<div class="t-item profit" style="justify-content: space-between;">
									<div>
										<div class="t-label">ğŸ’š LV2 ì˜ì—…ì´ìµ</div>
										<div class="t-amount">${(operatingProfit / 1000000000000).toFixed(1)}ì¡°</div>
									</div>
									<div style="font-size: 14px; font-weight: 700; color: #28a745;">${operatingProfitRatio}%</div>
								</div>
							</div>
						</div>

						<div class="t-divider"></div>

						<!-- ìš°ì¸¡: ë§¤ì¶œ -->
						<div class="t-column" style="flex: 1;">
							<div class="t-title">ëŒ€ë³€ (ë§¤ì¶œ)</div>
							<div class="t-group" style="flex: 1; display: flex; align-items: center; justify-content: center;">
								<div style="text-align: center;">
									<div class="t-label" style="font-size: 16px; margin-bottom: 12px;">ğŸ’™ LV1 ì˜ì—…ìˆ˜ìµ</div>
									<div class="t-amount" style="font-size: 32px; font-weight: 800; color: #4e73df;">${(revenue / 1000000000000).toFixed(1)}ì¡°</div>
									<div style="font-size: 16px; font-weight: 700; color: #4e73df; margin-top: 8px;">100.0%</div>
									<div style="font-size: 13px; color: #6c757d; margin-top: 12px;">${periodLabel}</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			`;
		}

		function renderBalanceSheet(data, companyName) {
			const container = document.getElementById('balanceSheet');
			if (!data) {
				container.innerHTML = '<div class="loading">ì¬ë¬´ìƒíƒœí‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
				return;
			}

			const totalAssets = data.total_assets || 0;
			const currentAssets = data.current_assets || 0;
			const nonCurrentAssets = data.non_current_assets || 0;
			const totalLiabilities = data.total_liabilities || 0;
			const totalEquity = data.total_equity || 0;

			// ë¹„ìœ¨ ê³„ì‚° (ì´ìì‚° ëŒ€ë¹„)
			const currentAssetsRatio = totalAssets > 0 ? (currentAssets / totalAssets * 100).toFixed(1) : 0;
			const nonCurrentAssetsRatio = totalAssets > 0 ? (nonCurrentAssets / totalAssets * 100).toFixed(1) : 0;
			const liabilitiesRatio = totalAssets > 0 ? (totalLiabilities / totalAssets * 100).toFixed(1) : 0;
			const equityRatio = totalAssets > 0 ? (totalEquity / totalAssets * 100).toFixed(1) : 0;

			// ì‹œê°ì  ë†’ì´ ê³„ì‚°
			const maxHeight = 500;
			const currentAssetsHeight = totalAssets > 0 ? (currentAssets / totalAssets) * maxHeight : 0;
			const nonCurrentAssetsHeight = totalAssets > 0 ? (nonCurrentAssets / totalAssets) * maxHeight : 0;
			const liabilitiesHeight = totalAssets > 0 ? (totalLiabilities / totalAssets) * maxHeight : 0;
			const equityHeight = totalAssets > 0 ? (totalEquity / totalAssets) * maxHeight : 0;

			container.innerHTML = `
				<div class="t-account-wrapper">
					<div class="t-account-container" style="align-items: end;">
						<div class="t-column">
							<div class="t-title">ìì‚° (${(totalAssets / 1000000000000).toFixed(1)}ì¡° | 100%)</div>
							<div class="t-item asset" style="height: ${currentAssetsHeight}px; min-height: 80px; padding: 12px 16px; display: flex; flex-direction: column; justify-content: center;">
								<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
									<div>
										<div class="t-label">ğŸ’µ ìœ ë™ìì‚°</div>
										<div class="t-amount">${(currentAssets / 1000000000000).toFixed(1)}ì¡°</div>
									</div>
									<div style="font-size: 16px; font-weight: 700; color: #17a2b8;">${currentAssetsRatio}%</div>
								</div>
							</div>
							<div class="t-item asset" style="height: ${nonCurrentAssetsHeight}px; min-height: 80px; padding: 12px 16px; display: flex; flex-direction: column; justify-content: center;">
								<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
									<div>
										<div class="t-label">ğŸ¢ ë¹„ìœ ë™ìì‚°</div>
										<div class="t-amount">${(nonCurrentAssets / 1000000000000).toFixed(1)}ì¡°</div>
									</div>
									<div style="font-size: 16px; font-weight: 700; color: #17a2b8;">${nonCurrentAssetsRatio}%</div>
								</div>
							</div>
						</div>
						<div class="t-divider"></div>
						<div class="t-column">
							<div class="t-title">ë¶€ì±„ + ìë³¸ (${((totalLiabilities + totalEquity) / 1000000000000).toFixed(1)}ì¡° | 100%)</div>
							<div class="t-item liability" style="height: ${liabilitiesHeight}px; min-height: 80px; padding: 12px 16px; display: flex; flex-direction: column; justify-content: center;">
								<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
									<div>
										<div class="t-label">ğŸ“› ë¶€ì±„</div>
										<div class="t-amount">${(totalLiabilities / 1000000000000).toFixed(1)}ì¡°</div>
									</div>
									<div style="font-size: 16px; font-weight: 700; color: #e74a3b;">${liabilitiesRatio}%</div>
								</div>
							</div>
							<div class="t-item equity" style="height: ${equityHeight}px; min-height: 80px; padding: 12px 16px; display: flex; flex-direction: column; justify-content: center;">
								<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
									<div>
										<div class="t-label">ğŸ’š ìë³¸</div>
										<div class="t-amount">${(totalEquity / 1000000000000).toFixed(1)}ì¡°</div>
									</div>
									<div style="font-size: 16px; font-weight: 700; color: #28a745;">${equityRatio}%</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			`;
		}

		function renderCashflowChart(cashflowData, companyName, periodType) {
			const ctx = document.getElementById('cashflowChart').getContext('2d');
			if (charts.cashflow) charts.cashflow.destroy();

			let filteredData = [];
			if (periodType === 'annual') {
				filteredData = cashflowData.filter(d =>
					d.report_type === '11011' &&
					d.year >= 2019 &&
					(d.operating_cf !== 0 || d.investing_cf !== 0 || d.financing_cf !== 0)
				);
			} else { // quarterly
				filteredData = cashflowData
					.filter(d =>
						d.report_type !== '11011' &&
						d.quarter &&
						d.year >= 2019 &&
						(d.operating_cf !== 0 || d.investing_cf !== 0 || d.financing_cf !== 0)
					)
					.sort((a, b) => {
						if (a.year !== b.year) return a.year - b.year;
						return a.quarter - b.quarter;
					});
			}

			if (filteredData.length === 0) {
				document.getElementById('cashflowView').querySelector('.chart-container').innerHTML =
					'<div class="loading">í•´ë‹¹ ê¸°ê°„ì˜ í˜„ê¸ˆíë¦„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
				return;
			}

			const labels = filteredData.map(d => d.period);
			const operatingCF = filteredData.map(d => d.operating_cf / 1000000000000);
			const investingCF = filteredData.map(d => d.investing_cf / 1000000000000);
			const financingCF = filteredData.map(d => d.financing_cf / 1000000000000);

			charts.cashflow = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [
						{ label: 'ì˜ì—…í™œë™', data: operatingCF, backgroundColor: 'rgba(78, 115, 223, 0.8)' },
						{ label: 'íˆ¬ìí™œë™', data: investingCF, backgroundColor: 'rgba(231, 74, 59, 0.8)' },
						{ label: 'ì¬ë¬´í™œë™', data: financingCF, backgroundColor: 'rgba(28, 200, 138, 0.8)' }
					]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						title: { display: true, text: `${companyName} í˜„ê¸ˆíë¦„`, font: { size: 18 }, color: '#343a40' },
						legend: { display: true, position: 'top' },
						datalabels: { display: false }
					},
					scales: {
						x: { stacked: true, grid: { color: '#e9ecef' } },
						y: { stacked: true, title: { display: true, text: 'ê¸ˆì•¡ (ì¡°ì›)' }, grid: { color: '#e9ecef' } }
					}
				}
			});
		}

		function populateCompanySelect() {
			const select = document.getElementById('companySelect');
			companies.forEach(company => {
				const option = document.createElement('option');
				option.value = company.code;
				option.textContent = `${company.name} (${company.stock || ''})`;
				select.appendChild(option);
			});
		}

		function changeCompany() {
			const selectedCode = document.getElementById('companySelect').value;
			if (!selectedCode) return;
			const company = companies.find(c => c.code === selectedCode);
			if (company) selectCompany(company.code, company.name);
		}

		function switchView(view) {
			document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
			event.target.classList.add('active');
			document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
			document.getElementById(view + 'View').classList.add('active');
		}

		async function loadData() {
			try {
				companies = await loadCompanies();
				populateCompanySelect();

				// Bind event listener for period selection
				document.getElementById('quarterSelect').addEventListener('change', updateAllViews);

				const samsung = companies.find(c => c.code === '00126380');
				if (samsung) {
					searchInput.value = samsung.name;
					await selectCompany(samsung.code, samsung.name);
				}
			} catch (error) {
				console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
			}
		}

		window.addEventListener('load', loadData);
	</script>
</body>
</html>