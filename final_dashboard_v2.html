<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>재무제표 분석 대시보드</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
			background: #0f172a;
			min-height: 100vh;
			padding: 0;
		}

		.container {
			max-width: 1400px;
			margin: 0 auto;
			padding: 20px;
		}

		/* Header */
		header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			padding: 30px 20px;
			margin-bottom: 20px;
			border-radius: 16px;
			box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
		}

		.header-content {
			max-width: 1400px;
			margin: 0 auto;
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 20px;
		}

		h1 {
			color: white;
			font-size: 28px;
			font-weight: 700;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.search-box {
			flex: 1;
			max-width: 500px;
			position: relative;
		}

		#companySearch {
			width: 100%;
			padding: 14px 45px 14px 20px;
			font-size: 16px;
			border: none;
			border-radius: 50px;
			background: rgba(255, 255, 255, 0.95);
			outline: none;
			transition: all 0.3s;
		}

		#companySearch:focus {
			background: white;
			box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
		}

		.search-icon {
			position: absolute;
			right: 20px;
			top: 50%;
			transform: translateY(-50%);
			font-size: 20px;
		}

		.search-results {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: white;
			border-radius: 16px;
			margin-top: 8px;
			max-height: 400px;
			overflow-y: auto;
			box-shadow: 0 20px 40px rgba(0,0,0,0.3);
			z-index: 1000;
			display: none;
		}

		.search-results.show { display: block; }

		.search-result-item {
			padding: 16px 20px;
			cursor: pointer;
			border-bottom: 1px solid #f1f5f9;
			transition: all 0.2s;
		}

		.search-result-item:hover {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}

		.company-name {
			font-weight: 700;
			font-size: 16px;
			margin-bottom: 4px;
		}

		.company-info {
			font-size: 13px;
			color: #64748b;
		}

		.search-result-item:hover .company-info {
			color: rgba(255,255,255,0.8);
		}

		/* Controls */
		.controls {
			display: flex;
			gap: 12px;
			margin-bottom: 20px;
			flex-wrap: wrap;
		}

		.view-btn {
			padding: 14px 28px;
			font-size: 15px;
			font-weight: 600;
			border: 2px solid #334155;
			border-radius: 12px;
			cursor: pointer;
			background: #1e293b;
			color: #cbd5e1;
			transition: all 0.3s;
		}

		.view-btn:hover {
			background: #334155;
			border-color: #475569;
		}

		.view-btn.active {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-color: transparent;
			box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
		}

		/* Content Card */
		.content-card {
			background: #1e293b;
			border-radius: 16px;
			padding: 30px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			margin-bottom: 20px;
		}

		.view-content { display: none; }
		.view-content.active { display: block; animation: fadeIn 0.4s; }

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(10px); }
			to { opacity: 1; transform: translateY(0); }
		}

		/* Trend Section */
		.trend-controls {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-bottom: 20px;
		}

		.control-group label {
			display: block;
			margin-bottom: 8px;
			font-weight: 600;
			color: #cbd5e1;
			font-size: 14px;
		}

		select {
			width: 100%;
			padding: 12px 16px;
			font-size: 15px;
			border: 2px solid #334155;
			border-radius: 10px;
			background: #0f172a;
			color: #cbd5e1;
			cursor: pointer;
			transition: all 0.3s;
		}

		select:focus {
			outline: none;
			border-color: #667eea;
			box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
		}

		.chart-container {
			height: 500px;
			background: #0f172a;
			padding: 20px;
			border-radius: 12px;
		}

		/* T-Account - Modern Grid Layout */
		.t-account-wrapper {
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
		}

		.t-account-container {
			display: grid;
			grid-template-columns: 1fr auto 1fr;
			gap: 20px;
			min-width: 800px;
			padding: 20px;
			background: #0f172a;
			border-radius: 12px;
		}

		.t-column {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.t-divider {
			width: 2px;
			background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
			border-radius: 1px;
		}

		.t-title {
			text-align: center;
			font-size: 20px;
			font-weight: 700;
			color: #cbd5e1;
			padding: 12px;
			background: #1e293b;
			border-radius: 10px;
			margin-bottom: 8px;
		}

		.t-group {
			background: #1e293b;
			border-radius: 10px;
			padding: 16px;
			border: 2px solid #334155;
		}

		.t-group-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border-radius: 8px;
			margin-bottom: 12px;
		}

		.t-group-title {
			font-size: 14px;
			font-weight: 700;
			color: white;
		}

		.t-group-total {
			font-size: 15px;
			font-weight: 700;
			color: white;
		}

		.t-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 16px;
			background: #334155;
			border-radius: 8px;
			margin-bottom: 8px;
			transition: all 0.2s;
			cursor: pointer;
		}

		.t-item:hover {
			transform: translateX(4px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
		}

		.t-item.expense {
			background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
		}

		.t-item.profit {
			background: linear-gradient(135deg, #10b981 0%, #059669 100%);
		}

		.t-item.revenue {
			background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
		}

		.t-item.asset {
			background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
		}

		.t-item.liability {
			background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
		}

		.t-item.equity {
			background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
		}

		.t-label {
			font-size: 14px;
			font-weight: 600;
			color: white;
		}

		.t-amount {
			font-size: 15px;
			font-weight: 700;
			color: white;
		}

		.loading {
			text-align: center;
			padding: 60px;
			color: #64748b;
			font-size: 16px;
		}

		/* Mobile Responsive */
		@media (max-width: 768px) {
			.container {
				padding: 10px;
			}

			header {
				padding: 20px 15px;
			}

			.header-content {
				flex-direction: column;
			}

			h1 {
				font-size: 22px;
			}

			.search-box {
				width: 100%;
				max-width: 100%;
			}

			.controls {
				flex-direction: column;
			}

			.view-btn {
				width: 100%;
				font-size: 14px;
				padding: 12px 20px;
			}

			.content-card {
				padding: 20px 15px;
			}

			.trend-controls {
				grid-template-columns: 1fr;
			}

			.chart-container {
				height: 350px;
				padding: 15px;
			}

			.t-account-container {
				min-width: 700px;
				padding: 15px;
				gap: 15px;
			}

			.t-title {
				font-size: 16px;
			}

			.t-group-header {
				padding: 10px;
			}

			.t-group-title {
				font-size: 12px;
			}

			.t-group-total {
				font-size: 13px;
			}

			.t-label {
				font-size: 12px;
			}

			.t-amount {
				font-size: 13px;
			}
		}

		/* Footer */
		.footer {
			text-align: center;
			padding: 20px;
			color: #64748b;
			font-size: 14px;
		}
	</style>
</head>
<body>
	<header>
		<div class="header-content">
			<h1>📊 재무제표 분석 대시보드</h1>
			<div class="search-box">
				<input type="text" id="companySearch" placeholder="종목 검색 (예: 삼성전자, LG에너지솔루션...)" autocomplete="off">
				<span class="search-icon">🔍</span>
				<div id="searchResults" class="search-results"></div>
			</div>
		</div>
	</header>

	<div class="container">
		<div class="controls">
			<button class="view-btn active" onclick="switchView('trend')">📈 추이 분석</button>
			<button class="view-btn" onclick="switchView('income')">📋 손익계산서</button>
			<button class="view-btn" onclick="switchView('quarterlyIncome')">🗓️ 분기 손익</button>
			<button class="view-btn" onclick="switchView('balance')">⚖️ 재무상태표</button>
			<button class="view-btn" onclick="switchView('cashflow')">💧 현금흐름</button>
		</div>

		<!-- 추이 분석 -->
		<div id="trendView" class="view-content active">
			<div class="content-card">
				<div class="trend-controls">
					<div class="control-group">
						<label>종목 선택</label>
						<select id="companySelect" onchange="changeCompany()">
							<option value="">-- 종목을 선택하세요 --</option>
						</select>
					</div>
					<div class="control-group">
						<label>기간 선택</label>
						<select id="quarterSelect" onchange="updateTrendChart()">
							<option value="annual">연간</option>
							<option value="1">1분기</option>
							<option value="2">2분기</option>
							<option value="3">3분기</option>
						</select>
					</div>
				</div>
				<div class="chart-container">
					<canvas id="trendChart"></canvas>
				</div>
			</div>
		</div>

		<!-- 연간 손익계산서 -->
		<div id="incomeView" class="view-content">
			<div class="content-card">
				<div id="incomeStatement" class="loading">데이터 로딩 중...</div>
			</div>
		</div>

		<!-- 분기 손익계산서 -->
		<div id="quarterlyIncomeView" class="view-content">
			<div class="content-card">
				<div id="quarterlyIncomeStatement" class="loading">데이터 로딩 중...</div>
			</div>
		</div>

		<!-- 재무상태표 -->
		<div id="balanceView" class="view-content">
			<div class="content-card">
				<div id="balanceSheet" class="loading">데이터 로딩 중...</div>
			</div>
		</div>

		<!-- 현금흐름 -->
		<div id="cashflowView" class="view-content">
			<div class="content-card">
				<div class="chart-container">
					<canvas id="cashflowChart"></canvas>
				</div>
			</div>
		</div>

		<div class="footer">
			<p>📡 데이터 출처: 금융감독원 전자공시시스템 (DART) via Supabase</p>
		</div>
	</div>

	<script>
		// Supabase 초기화
		const SUPABASE_URL = 'https://tnkcxygqguxgiwnqsrcd.supabase.co';
		const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRua2N4eWdxZ3V4Z2l3bnFzcmNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MzMxNjYsImV4cCI6MjA3NjIwOTE2Nn0.w3U5zwSslhB4yi0Xp0C-dRymLYkuA7P1Tv9VXRMdCI4';
		const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

		let charts = {};
		let companies = [];
		let currentCompanyCode = null;
		let currentCompanyName = null;
		let allCompanyData = {};

		Chart.register(ChartDataLabels);

		// Chart.js 기본 색상 설정 (다크 모드)
		Chart.defaults.color = '#cbd5e1';
		Chart.defaults.borderColor = '#334155';

		async function loadCompanies() {
			const { data, error } = await supabase.from('companies').select('*').order('corp_name');
			if (error) {
				console.error('기업 목록 로드 실패:', error);
				return [];
			}
			return data.map(company => ({
				name: company.corp_name,
				code: company.corp_code,
				stock: company.stock_code,
				sector: company.sector
			}));
		}

		async function loadIncomeStatements(corpCode) {
			const { data, error } = await supabase.from('income_statements').select('*').eq('corp_code', corpCode).order('year');
			if (error) return [];
			return data.map(d => ({
				year: d.year,
				report_type: d.report_type,
				quarter: d.report_type === '11013' ? 1 : d.report_type === '11012' ? 2 : d.report_type === '11014' ? 3 : null,
				revenue: d.revenue || 0,
				cost_of_sales: d.cost_of_sales || 0,
				gross_profit: d.gross_profit || 0,
				selling_admin_expenses: d.selling_admin_expenses || 0,
				operating_profit: d.operating_profit || 0,
				operating_margin: d.operating_margin || 0
			}));
		}

		async function loadBalanceSheets(corpCode) {
			const { data, error } = await supabase.from('balance_sheets').select('*').eq('corp_code', corpCode).eq('report_type', '11011').order('year', { ascending: false }).limit(1);
			if (error) return null;
			return data[0] || null;
		}

		async function loadCashFlows(corpCode) {
			const { data, error } = await supabase.from('cash_flows').select('*').eq('corp_code', corpCode).eq('report_type', '11011').order('year');
			if (error) return [];
			return data.map(d => ({
				period: d.year + '년',
				operating_cf: d.operating_cash_flow || 0,
				investing_cf: d.investing_cash_flow || 0,
				financing_cf: d.financing_cash_flow || 0
			}));
		}

		// 검색 기능
		const searchInput = document.getElementById('companySearch');
		const searchResults = document.getElementById('searchResults');

		searchInput.addEventListener('input', (e) => {
			const query = e.target.value.trim().toLowerCase();
			if (query.length === 0) {
				searchResults.classList.remove('show');
				return;
			}

			const filtered = companies.filter(company =>
				company.name.toLowerCase().includes(query) ||
				company.stock.includes(query) ||
				company.sector.toLowerCase().includes(query)
			);

			if (filtered.length === 0) {
				searchResults.innerHTML = '<div class="loading">검색 결과가 없습니다</div>';
				searchResults.classList.add('show');
				return;
			}

			searchResults.innerHTML = filtered.map(company => `
				<div class="search-result-item" onclick="selectCompany('${company.code}', '${company.name}')">
					<div class="company-name">${company.name}</div>
					<div class="company-info">${company.stock} | ${company.sector}</div>
				</div>
			`).join('');

			searchResults.classList.add('show');
		});

		document.addEventListener('click', (e) => {
			if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
				searchResults.classList.remove('show');
			}
		});

		async function selectCompany(code, name) {
			searchResults.classList.remove('show');
			searchInput.value = name;
			currentCompanyCode = code;
			currentCompanyName = name;

			document.getElementById('companySelect').value = code;

			console.log(`${name} 데이터 로딩 중...`);
			const incomeData = await loadIncomeStatements(code);
			const balanceData = await loadBalanceSheets(code);
			const cashflowData = await loadCashFlows(code);

			if (incomeData.length === 0) {
				alert(`${name} 데이터가 없습니다.`);
				return;
			}

			allCompanyData[code] = { income: incomeData, balance: balanceData, cashflow: cashflowData };
			updateChartsForCompany(code, name);
		}

		function updateChartsForCompany(code, name) {
			const data = allCompanyData[code];
			if (!data || !data.income || data.income.length === 0) return;

			const annualData = data.income.filter(d => d.report_type === '11011');
			const quarterlyData = data.income.filter(d => d.report_type !== '11011');

			renderTrendChart(data.income, name, document.getElementById('quarterSelect').value);
			if (annualData.length > 0) renderIncomeStatement(annualData[annualData.length - 1], name);
			renderQuarterlyIncomeStatement(quarterlyData, name);
			renderBalanceSheet(data.balance, name);
			renderCashflowChart(data.cashflow, name);
		}

		function renderTrendChart(incomeData, companyName, selectedQuarter) {
			let filteredData = [];
			if (selectedQuarter === 'annual') {
				filteredData = incomeData.filter(d => d.report_type === '11011');
			} else {
				filteredData = incomeData.filter(d => d.report_type !== '11011' && d.quarter == selectedQuarter);
			}

			const ctx = document.getElementById('trendChart').getContext('2d');
			if (charts.trend) charts.trend.destroy();

			const labels = filteredData.map(d => d.year + '년' + (d.quarter ? ` Q${d.quarter}` : ''));
			const revenues = filteredData.map(d => d.revenue / 1000000000000);
			const profits = filteredData.map(d => d.operating_profit / 1000000000000);
			const margins = filteredData.map(d => (d.operating_profit / d.revenue * 100));

			charts.trend = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: '매출 (조원)',
						data: revenues,
						backgroundColor: 'rgba(59, 130, 246, 0.8)',
						borderColor: 'rgba(59, 130, 246, 1)',
						borderWidth: 2,
						borderRadius: 8,
						yAxisID: 'y'
					}, {
						label: '영업이익 (조원)',
						data: profits,
						type: 'line',
						borderColor: 'rgba(16, 185, 129, 1)',
						backgroundColor: 'rgba(16, 185, 129, 0.1)',
						borderWidth: 3,
						pointRadius: 6,
						tension: 0.4,
						yAxisID: 'y'
					}, {
						label: '영업이익률 (%)',
						data: margins,
						type: 'line',
						borderColor: 'rgba(245, 158, 11, 1)',
						backgroundColor: 'rgba(245, 158, 11, 0.1)',
						borderWidth: 3,
						borderDash: [5, 5],
						pointRadius: 8,
						tension: 0.4,
						yAxisID: 'y1'
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						title: {
							display: true,
							text: `${companyName} 매출 및 영업이익 추이`,
							font: { size: 18 },
							color: '#cbd5e1'
						},
						legend: { display: true, position: 'top' },
						datalabels: { display: false }
					},
					scales: {
						y: {
							beginAtZero: true,
							title: { display: true, text: '금액 (조원)' },
							grid: { color: '#334155' }
						},
						y1: {
							position: 'right',
							beginAtZero: true,
							title: { display: true, text: '영업이익률 (%)' },
							grid: { drawOnChartArea: false, color: '#334155' }
						},
						x: {
							grid: { color: '#334155' }
						}
					}
				}
			});
		}

		function updateTrendChart() {
			if (!currentCompanyCode || !allCompanyData[currentCompanyCode]) return;
			const data = allCompanyData[currentCompanyCode];
			renderTrendChart(data.income, currentCompanyName, document.getElementById('quarterSelect').value);
		}

		function renderIncomeStatement(data, companyName) {
			if (!data) return;
			const container = document.getElementById('incomeStatement');

			container.innerHTML = `
				<div class="t-account-wrapper">
					<div class="t-account-container">
						<div class="t-column">
							<div class="t-title">비용 + 영업이익</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">💰 매출원가</span>
									<span class="t-group-total">${(data.cost_of_sales / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item expense">
									<span class="t-label">총 매출원가</span>
									<span class="t-amount">${(data.cost_of_sales / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">📊 판매관리비</span>
									<span class="t-group-total">${(data.selling_admin_expenses / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item expense">
									<span class="t-label">총 판매관리비</span>
									<span class="t-amount">${(data.selling_admin_expenses / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
							<div class="t-item profit">
								<span class="t-label">💚 영업이익</span>
								<span class="t-amount">${(data.operating_profit / 1000000000000).toFixed(1)}조</span>
							</div>
						</div>
						<div class="t-divider"></div>
						<div class="t-column">
							<div class="t-title">매출</div>
							<div class="t-item revenue" style="min-height: 120px; align-items: center;">
								<span class="t-label">💙 영업수익 (${data.year}년)</span>
								<span class="t-amount">${(data.revenue / 1000000000000).toFixed(1)}조</span>
							</div>
						</div>
					</div>
				</div>
			`;
		}

		function renderQuarterlyIncomeStatement(quarterlyData, companyName) {
			const container = document.getElementById('quarterlyIncomeStatement');
			if (!quarterlyData || quarterlyData.length === 0) {
				container.innerHTML = '<div class="loading">분기 손익계산서 데이터가 없습니다.</div>';
				return;
			}

			const latest = quarterlyData[quarterlyData.length - 1];
			container.innerHTML = `
				<div class="t-account-wrapper">
					<div class="t-account-container">
						<div class="t-column">
							<div class="t-title">비용 + 영업이익</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">💰 매출원가</span>
									<span class="t-group-total">${(latest.cost_of_sales / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item expense">
									<span class="t-label">총 매출원가</span>
									<span class="t-amount">${(latest.cost_of_sales / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">📊 판매관리비</span>
									<span class="t-group-total">${(latest.selling_admin_expenses / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item expense">
									<span class="t-label">총 판매관리비</span>
									<span class="t-amount">${(latest.selling_admin_expenses / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
							<div class="t-item profit">
								<span class="t-label">💚 영업이익</span>
								<span class="t-amount">${(latest.operating_profit / 1000000000000).toFixed(1)}조</span>
							</div>
						</div>
						<div class="t-divider"></div>
						<div class="t-column">
							<div class="t-title">매출</div>
							<div class="t-item revenue" style="min-height: 120px; align-items: center;">
								<span class="t-label">💙 영업수익 (${latest.year}년 Q${latest.quarter})</span>
								<span class="t-amount">${(latest.revenue / 1000000000000).toFixed(1)}조</span>
							</div>
						</div>
					</div>
				</div>
			`;
		}

		function renderBalanceSheet(data, companyName) {
			const container = document.getElementById('balanceSheet');
			if (!data) {
				container.innerHTML = '<div class="loading">재무상태표 데이터가 없습니다.</div>';
				return;
			}

			container.innerHTML = `
				<div class="t-account-wrapper">
					<div class="t-account-container">
						<div class="t-column">
							<div class="t-title">자산</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">💵 유동자산</span>
									<span class="t-group-total">${(data.current_assets / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item asset">
									<span class="t-label">유동자산 합계</span>
									<span class="t-amount">${(data.current_assets / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">🏢 비유동자산</span>
									<span class="t-group-total">${(data.non_current_assets / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item asset">
									<span class="t-label">비유동자산 합계</span>
									<span class="t-amount">${(data.non_current_assets / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
						</div>
						<div class="t-divider"></div>
						<div class="t-column">
							<div class="t-title">부채 + 자본</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">📛 유동부채</span>
									<span class="t-group-total">${(data.current_liabilities / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item liability">
									<span class="t-label">유동부채 합계</span>
									<span class="t-amount">${(data.current_liabilities / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">📕 비유동부채</span>
									<span class="t-group-total">${(data.non_current_liabilities / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item liability">
									<span class="t-label">비유동부채 합계</span>
									<span class="t-amount">${(data.non_current_liabilities / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
							<div class="t-group">
								<div class="t-group-header">
									<span class="t-group-title">💚 자본</span>
									<span class="t-group-total">${(data.total_equity / 1000000000000).toFixed(1)}조</span>
								</div>
								<div class="t-item equity">
									<span class="t-label">자본 합계</span>
									<span class="t-amount">${(data.total_equity / 1000000000000).toFixed(1)}조</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			`;
		}

		function renderCashflowChart(cashflowData, companyName) {
			const ctx = document.getElementById('cashflowChart').getContext('2d');
			if (charts.cashflow) charts.cashflow.destroy();

			if (!cashflowData || cashflowData.length === 0) {
				document.getElementById('cashflowView').querySelector('.chart-container').innerHTML =
					'<div class="loading">현금흐름 데이터가 없습니다.</div>';
				return;
			}

			const labels = cashflowData.map(d => d.period);
			const operatingCF = cashflowData.map(d => d.operating_cf / 1000000000000);
			const investingCF = cashflowData.map(d => d.investing_cf / 1000000000000);
			const financingCF = cashflowData.map(d => d.financing_cf / 1000000000000);

			charts.cashflow = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [
						{ label: '영업활동', data: operatingCF, backgroundColor: 'rgba(59, 130, 246, 0.8)' },
						{ label: '투자활동', data: investingCF, backgroundColor: 'rgba(239, 68, 68, 0.8)' },
						{ label: '재무활동', data: financingCF, backgroundColor: 'rgba(16, 185, 129, 0.8)' }
					]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						title: { display: true, text: `${companyName} 현금흐름`, font: { size: 18 }, color: '#cbd5e1' },
						legend: { display: true, position: 'top' },
						datalabels: { display: false }
					},
					scales: {
						x: { stacked: true, grid: { color: '#334155' } },
						y: { stacked: true, title: { display: true, text: '금액 (조원)' }, grid: { color: '#334155' } }
					}
				}
			});
		}

		function populateCompanySelect() {
			const select = document.getElementById('companySelect');
			companies.forEach(company => {
				const option = document.createElement('option');
				option.value = company.code;
				option.textContent = `${company.name} (${company.stock})`;
				select.appendChild(option);
			});
		}

		function changeCompany() {
			const selectedCode = document.getElementById('companySelect').value;
			if (!selectedCode) return;
			const company = companies.find(c => c.code === selectedCode);
			if (company) selectCompany(company.code, company.name);
		}

		function switchView(view) {
			document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
			event.target.classList.add('active');
			document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
			document.getElementById(view + 'View').classList.add('active');
		}

		async function loadData() {
			try {
				companies = await loadCompanies();
				populateCompanySelect();

				const samsung = companies.find(c => c.code === '00126380');
				if (samsung) {
					searchInput.value = samsung.name;
					await selectCompany(samsung.code, samsung.name);
				}
			} catch (error) {
				console.error('데이터 로드 실패:', error);
			}
		}

		window.addEventListener('load', loadData);
	</script>
</body>
</html>
